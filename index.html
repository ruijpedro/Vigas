<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Solver de Vigas</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, select { margin: 2px; }
    .chart { height: 250px; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="root"></div>

<script type="text/babel">

const { useState, useMemo } = React;
const { LineChart, Line, CartesianGrid, XAxis, YAxis, Tooltip, ResponsiveContainer } = Recharts;
const { jsPDF } = window.jspdf;

function uid(){ return Date.now() + Math.floor(Math.random()*1e6); }

function solveBeam({pointLoads,udls,moments,Ltot=6}){
  const N=50;
  const ptsM=[], ptsV=[], ptsDefl=[];
  for(let i=0;i<=N;i++){
    const x=Ltot*i/N;
    let V=0, M=0;
    for(const p of pointLoads) if(x>=p.x){ V+=p.P; M+=p.P*(x-p.x);}
    for(const u of udls){ if(x>=u.a){ const len=Math.min(x,u.b)-u.a; if(len>0){ V+=u.w*len; M+=u.w*len*(x-(u.a+len/2)); }}}
    for(const m of moments) if(x>=m.x) M+=m.M;
    ptsM.push({x,M}); ptsV.push({x,V}); ptsDefl.push({x,v:M/1000});
  }
  return {
    ptsM, ptsV, ptsDefl,
    extrema:{
      Vmax:Math.max(...ptsV.map(p=>p.V)), Vmin:Math.min(...ptsV.map(p=>p.V)),
      Mmax:Math.max(...ptsM.map(p=>p.M)), Mmin:Math.min(...ptsM.map(p=>p.M)),
      vMax:ptsDefl.reduce((a,b)=>Math.abs(b.v)>Math.abs(a.v)?b:a,ptsDefl[0])
    }
  };
}

function App(){
  const [pl,setPL]=useState([]);
  const [udl,setUDL]=useState([]);
  const [ml,setML]=useState([]);
  const out=useMemo(()=>solveBeam({pointLoads:pl,udls:udl,moments:ml}),[pl,udl,ml]);

  function exportCSV(){
    let csv="x,V,M,δ\n";
    out.ptsM.forEach((p,i)=>{csv+=`${p.x},${out.ptsV[i].V},${p.M},${out.ptsDefl[i].v}\n`;});
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="diagramas.csv";a.click();
  }

  async function exportPDF(){
    const doc=new jsPDF();
    doc.text("Relatório de Viga",14,15);
    doc.autoTable({startY:25, head:[["Grandeza","Valor"]],
      body:[
        ["Vmax",out.extrema.Vmax.toFixed(2)+" kN"],
        ["Mmax",out.extrema.Mmax.toFixed(2)+" kNm"],
        ["δmax",out.extrema.vMax.v.toExponential(2)+" m"]
      ]});
    const svg=document.querySelector("#chartM svg");
    const dataUrl="data:image/svg+xml;base64,"+btoa(new XMLSerializer().serializeToString(svg));
    doc.addImage(dataUrl,"PNG",15,80,180,80);
    doc.save("relatorio_viga.pdf");
  }

  return <div>
    <h1>Solver de Vigas</h1>

    <h2>Cargas Pontuais</h2>
    {pl.map((c,i)=><div key={c.id}>
      x:<input type="number" value={c.x} onChange={e=>{
        const arr=[...pl];arr[i].x=+e.target.value;setPL(arr);}}/>
      P:<input type="number" value={c.P} onChange={e=>{
        const arr=[...pl];arr[i].P=+e.target.value;setPL(arr);}}/>
    </div>)}
    <button onClick={()=>setPL([...pl,{id:uid(),x:2,P:-10}])}>+ Ponto</button>

    <h2>UDL</h2>
    {udl.map((u,i)=><div key={u.id}>
      a:<input type="number" value={u.a} onChange={e=>{
        const arr=[...udl];arr[i].a=+e.target.value;setUDL(arr);}}/>
      b:<input type="number" value={u.b} onChange={e=>{
        const arr=[...udl];arr[i].b=+e.target.value;setUDL(arr);}}/>
      w:<input type="number" value={u.w} onChange={e=>{
        const arr=[...udl];arr[i].w=+e.target.value;setUDL(arr);}}/>
    </div>)}
    <button onClick={()=>setUDL([...udl,{id:uid(),a:0,b:3,w:-5}])}>+ UDL</button>

    <h2>Momentos</h2>
    {ml.map((m,i)=><div key={m.id}>
      x:<input type="number" value={m.x} onChange={e=>{
        const arr=[...ml];arr[i].x=+e.target.value;setML(arr);}}/>
      M:<input type="number" value={m.M} onChange={e=>{
        const arr=[...ml];arr[i].M=+e.target.value;setML(arr);}}/>
    </div>)}
    <button onClick={()=>setML([...ml,{id:uid(),x:1,M:5}])}>+ Momento</button>

    <div>
      <button onClick={exportCSV}>Exportar CSV</button>
      <button onClick={exportPDF}>Exportar PDF</button>
    </div>

    <h3>Resultados</h3>
    <div>
      Vmax={out.extrema.Vmax.toFixed(2)} · 
      Mmax={out.extrema.Mmax.toFixed(2)} · 
      δmax={out.extrema.vMax.v.toExponential(2)}
    </div>

    <div id="chartM" className="chart">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={out.ptsM}>
          <CartesianGrid strokeDasharray="3 3"/>
          <XAxis dataKey="x"/><YAxis/><Tooltip/>
          <Line type="monotone" dataKey="M" stroke="#f00" dot={false}/>
        </LineChart>
      </ResponsiveContainer>
    </div>

    <div className="chart">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={out.ptsV}>
          <CartesianGrid strokeDasharray="3 3"/>
          <XAxis dataKey="x"/><YAxis/><Tooltip/>
          <Line type="monotone" dataKey="V" stroke="#00f" dot={false}/>
        </LineChart>
      </ResponsiveContainer>
    </div>

    <div className="chart">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={out.ptsDefl}>
          <CartesianGrid strokeDasharray="3 3"/>
          <XAxis dataKey="x"/><YAxis/><Tooltip/>
          <Line type="monotone" dataKey="v" stroke="#0a0" dot={false}/>
        </LineChart>
      </ResponsiveContainer>
    </div>
  </div>;
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
